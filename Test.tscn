[gd_scene load_steps=4 format=2]

[ext_resource path="res://src/cable/Cable.tscn" type="PackedScene" id=1]
[ext_resource path="res://src/power_generator/PowerGenerator.tscn" type="PackedScene" id=2]

[sub_resource type="GDScript" id=1]
script/source = "extends Node

export var POWER_RATIO: float

var current_power: float = 0.0 setget set_current_power
var consumption_rate: float = 0.0 setget set_consumption_rate

onready var power: Node2D = $PowerGenerator
onready var cables: Array = get_tree().get_nodes_in_group(\"cables\")

onready var power_label: Label = $Control/VBoxContainer/HBoxContainer/PowerValue
onready var consumption_label: Label = $Control/VBoxContainer/HBoxContainer2/ConsumptionValue
onready var net_label: Label = $Control/VBoxContainer/HBoxContainer3/NetValue

func _ready() -> void:
	assert(POWER_RATIO > 0)
	
	for cable in cables:
		cable.connect(\"rotated\", self, \"_on_Cable_rotated\")
		
		
func set_current_power(value: float) -> float:
	current_power = value
	power_label.text = str(current_power)
	return current_power


func set_consumption_rate(value: float) -> float:
	consumption_rate = value
	consumption_label.text = str(consumption_rate)
	return consumption_rate


func _on_Cable_rotated() -> void:
	var connected: Array = _traverse_nodes(power.currentNode)
	for cable in cables:
		var id: int = cable.get_instance_id()
		cable.set_power(connected.has(id))
	
	

func _traverse_nodes(current: Node2D, visited: Array = []) -> Array:
	if current == null:
		return visited
	
	
	var id = current.get_instance_id()
	
	# If the current instance has already been visited skip it, otherwise
	# add it to the already visited list.
	if visited.has(id):
		return visited
		
	visited.append(id)
	
	if not current.is_in_group(\"cables\"):
		return visited
	
	# Check if the current node is a cable and which edges are connected to
	# anything.
	
	for node in _traverse_nodes(current.get_up_node(), visited):
		if visited.has(node):
			continue
		else:
			visited.append(node)
	for node in _traverse_nodes(current.get_right_node(), visited):
		if visited.has(node):
			continue
		else:
			visited.append(node) 	
	for node in _traverse_nodes(current.get_down_node(), visited):
		if visited.has(node):
			continue
		else:
			visited.append(node) 	
	for node in _traverse_nodes(current.get_left_node(), visited):
		if visited.has(node):
			continue
		else:
			visited.append(node) 	
	return visited

"

[node name="Test" type="Node"]
script = SubResource( 1 )
POWER_RATIO = 10.0

[node name="PowerGenerator" parent="." groups=["generator"] instance=ExtResource( 2 )]
position = Vector2( 40, 96 )

[node name="Cable" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 96, 96 )
TYPE = 1

[node name="Cable2" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 96, 128 )
TYPE = 1

[node name="Cable3" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 128, 96 )
TYPE = 1

[node name="Cable4" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 128, 128 )
TYPE = 1

[node name="Cable5" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 160, 96 )
TYPE = 1

[node name="Cable6" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 160, 128 )
TYPE = 1

[node name="Cable7" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 96, 160 )
TYPE = 1

[node name="Cable8" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 96, 192 )
TYPE = 1

[node name="Cable9" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 128, 160 )
TYPE = 1

[node name="Cable10" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 128, 192 )
TYPE = 1

[node name="Cable11" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 160, 160 )
TYPE = 1

[node name="Cable12" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 160, 192 )
TYPE = 1

[node name="Cable13" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 96, 224 )
TYPE = 1

[node name="Cable14" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 96, 256 )
TYPE = 1

[node name="Cable15" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 128, 224 )
TYPE = 1

[node name="Cable16" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 128, 256 )
TYPE = 1

[node name="Cable17" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 160, 224 )
TYPE = 1

[node name="Cable18" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 160, 256 )
TYPE = 1

[node name="Cable19" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 96, 288 )
TYPE = 1

[node name="Cable20" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 96, 320 )
TYPE = 1

[node name="Cable21" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 128, 288 )
TYPE = 1

[node name="Cable22" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 128, 320 )
TYPE = 1

[node name="Cable23" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 160, 288 )
TYPE = 1

[node name="Cable24" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 160, 320 )
TYPE = 1

[node name="Cable25" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 192, 96 )
TYPE = 1

[node name="Cable26" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 192, 128 )
TYPE = 1

[node name="Cable27" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 224, 96 )
TYPE = 1

[node name="Cable28" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 224, 128 )
TYPE = 1

[node name="Cable29" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 256, 96 )
TYPE = 1

[node name="Cable30" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 256, 128 )
TYPE = 1

[node name="Cable31" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 192, 160 )
TYPE = 1

[node name="Cable32" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 192, 192 )
TYPE = 1

[node name="Cable33" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 224, 160 )
TYPE = 1

[node name="Cable34" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 224, 192 )
TYPE = 1

[node name="Cable35" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 256, 160 )
TYPE = 1

[node name="Cable36" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 256, 192 )
TYPE = 1

[node name="Cable37" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 192, 224 )
TYPE = 1

[node name="Cable38" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 192, 256 )
TYPE = 1

[node name="Cable39" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 224, 224 )
TYPE = 1

[node name="Cable40" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 224, 256 )
TYPE = 1

[node name="Cable41" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 256, 224 )
TYPE = 1

[node name="Cable42" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 256, 256 )
TYPE = 1

[node name="Cable43" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 192, 288 )
TYPE = 1

[node name="Cable44" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 192, 320 )
TYPE = 1

[node name="Cable45" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 224, 288 )
TYPE = 1

[node name="Cable46" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 224, 320 )
TYPE = 1

[node name="Cable47" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 256, 288 )
TYPE = 1

[node name="Cable48" parent="." groups=["cables"] instance=ExtResource( 1 )]
position = Vector2( 256, 320 )
TYPE = 1
