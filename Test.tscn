[gd_scene load_steps=7 format=2]

[ext_resource path="res://src/cable/Cable.tscn" type="PackedScene" id=1]
[ext_resource path="res://src/power_generator/PowerGenerator.tscn" type="PackedScene" id=2]
[ext_resource path="res://src/power_consumer/XRay.tscn" type="PackedScene" id=3]
[ext_resource path="res://src/power_consumer/Bedroom.tscn" type="PackedScene" id=4]
[ext_resource path="res://src/power_consumer/BloodBank.tscn" type="PackedScene" id=5]

[sub_resource type="GDScript" id=1]
script/source = "extends Node

export var POWER_RATIO: float

var current_power: float = 0.0 setget set_current_power
var consumption_rate: float = 0.0 setget set_consumption_rate

onready var power: Node2D = $PowerGenerator

onready var power_label: Label = $Control/VBoxContainer/HBoxContainer/PowerValue
onready var consumption_label: Label = $Control/VBoxContainer/HBoxContainer2/ConsumptionValue
onready var net_label: Label = $Control/VBoxContainer/HBoxContainer3/NetValue

func _ready() -> void:
	assert(POWER_RATIO > 0)


func _process(delta: float) -> void:
	var current_nodes: Array = traverse_connected_to_current()
	var consumption: float = 0.0
	for id in current_nodes:
		var instance = instance_from_id(id)
		if \"CONSUMPTION_RATE\" in instance:
			consumption += instance.CONSUMPTION_RATE
	set_consumption_rate(consumption * delta)
	
	if Input.is_action_just_pressed(\"ui_accept\"):
		set_current_power(current_power + POWER_RATIO * delta)

func traverse_connected_to_current() -> Array:
	return _traverse_nodes(power.currentNode)


func set_current_power(value: float) -> float:
	current_power = value
	power_label.text = str(current_power)
	return current_power


func set_consumption_rate(value: float) -> float:
	consumption_rate = value
	consumption_label.text = str(consumption_rate)
	return consumption_rate


func _traverse_nodes(current: Node2D, visited: Array = []) -> Array:
	if current == null:
		return visited
	
	var id = current.get_instance_id()
	
	# If the current instance has already been visited skip it, otherwise
	# add it to the already visited list.
	if visited.has(id):
		return visited
	else:
		visited.append(id)
	
	# Since we are traversing from the power node, any node that we are able
	# to visit are connected to power and thus their state must be set to `true`
	if current.has_method(\"set_power\"):
		current.set_power(true)
	
	if current.has_method(\"is_powered\"):
		current.is_powered()
	
	# Check if the current node is a cable and which edges are connected to
	# anything.
	if \"upNode\" in current:
		_traverse_nodes(current.upNode, visited)
	if \"downNode\" in current:
		_traverse_nodes(current.downNode, visited)
	if \"rightNode\" in current:
		_traverse_nodes(current.rightNode, visited)
	if \"leftNode\" in current:
		_traverse_nodes(current.downNode, visited)
	
	return visited
"

[node name="Test" type="Node"]
script = SubResource( 1 )
POWER_RATIO = 10.0

[node name="PowerGenerator" parent="." instance=ExtResource( 2 )]
position = Vector2( 160, 160 )

[node name="Cable" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 160 )
TYPE = 1

[node name="Cable2" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 160 )
TYPE = 2

[node name="Cable3" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 192 )
TYPE = 1

[node name="Cable4" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 192 )
TYPE = 3

[node name="Cable5" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 160 )

[node name="Cable6" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 192 )
TYPE = 1

[node name="Cable10" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 192 )
TYPE = 1

[node name="Cable9" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 224 )
TYPE = 1

[node name="Cable11" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 224 )
TYPE = 1

[node name="Cable12" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 224 )
TYPE = 1

[node name="Cable13" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 224 )
TYPE = 1

[node name="Cable14" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 256 )
TYPE = 1

[node name="Cable15" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 256 )
TYPE = 1

[node name="Cable56" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 288 )
TYPE = 1

[node name="Cable67" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 288 )
TYPE = 1

[node name="Cable16" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 256 )
TYPE = 1

[node name="Cable17" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 256 )
TYPE = 1

[node name="Cable18" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 128 )
TYPE = 1

[node name="Cable19" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 128 )
TYPE = 1

[node name="Cable20" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 128 )
TYPE = 1

[node name="Cable21" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 128 )
TYPE = 1

[node name="Cable22" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 96 )
TYPE = 1

[node name="Cable23" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 96 )
TYPE = 1

[node name="Cable24" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 96 )
TYPE = 1

[node name="Cable25" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 96 )
TYPE = 1

[node name="Cable26" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 64 )
TYPE = 1

[node name="Cable27" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 64 )
TYPE = 1

[node name="Cable30" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 32 )
TYPE = 1

[node name="Cable31" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 32 )
TYPE = 1

[node name="Cable28" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 64 )
TYPE = 1

[node name="Cable29" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 64 )
TYPE = 1

[node name="Cable32" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 32 )
TYPE = 1

[node name="Cable33" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 128 )
TYPE = 1

[node name="Cable34" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 96 )
TYPE = 1

[node name="Cable35" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 64 )
TYPE = 1

[node name="Cable36" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 32 )
TYPE = 1

[node name="Cable37" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 128 )
TYPE = 1

[node name="Cable38" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 96 )
TYPE = 1

[node name="Cable39" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 64 )
TYPE = 1

[node name="Cable40" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 32 )
TYPE = 1

[node name="Cable41" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 128 )
TYPE = 1

[node name="Cable42" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 96 )
TYPE = 1

[node name="Cable43" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 64 )
TYPE = 1

[node name="Cable44" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 32 )
TYPE = 1

[node name="Cable45" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 128 )
TYPE = 1

[node name="Cable49" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 160 )
TYPE = 1

[node name="Cable50" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 160 )
TYPE = 1

[node name="Cable51" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 160 )
TYPE = 1

[node name="Cable46" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 96 )
TYPE = 1

[node name="Cable47" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 64 )
TYPE = 1

[node name="Cable48" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 32 )
TYPE = 1

[node name="Cable78" parent="." instance=ExtResource( 1 )]
position = Vector2( 480, 64 )
TYPE = 1

[node name="Cable79" parent="." instance=ExtResource( 1 )]
position = Vector2( 480, 32 )
TYPE = 1

[node name="Cable80" parent="." instance=ExtResource( 1 )]
position = Vector2( 512, 64 )
TYPE = 1

[node name="Cable81" parent="." instance=ExtResource( 1 )]
position = Vector2( 512, 32 )
TYPE = 1

[node name="Cable82" parent="." instance=ExtResource( 1 )]
position = Vector2( 512, 128 )
TYPE = 1

[node name="Cable83" parent="." instance=ExtResource( 1 )]
position = Vector2( 512, 96 )
TYPE = 1

[node name="Cable73" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 320 )
TYPE = 1

[node name="Cable74" parent="." instance=ExtResource( 1 )]
position = Vector2( 480, 128 )
TYPE = 1

[node name="Cable75" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 288 )
TYPE = 1

[node name="Cable76" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 256 )
TYPE = 1

[node name="Cable77" parent="." instance=ExtResource( 1 )]
position = Vector2( 448, 224 )
TYPE = 1

[node name="Cable52" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 288 )
TYPE = 1

[node name="Cable53" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 256 )
TYPE = 1

[node name="Cable54" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 224 )
TYPE = 1

[node name="Cable55" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 192 )
TYPE = 1

[node name="Cable57" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 256 )
TYPE = 1

[node name="Cable58" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 224 )
TYPE = 1

[node name="Cable59" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 192 )
TYPE = 1

[node name="Cable60" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 288 )
TYPE = 1

[node name="Cable61" parent="." instance=ExtResource( 1 )]
position = Vector2( 352, 320 )
TYPE = 1

[node name="Cable68" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 320 )
TYPE = 1

[node name="Cable71" parent="." instance=ExtResource( 1 )]
position = Vector2( 256, 320 )
TYPE = 1

[node name="Cable69" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 288 )
TYPE = 1

[node name="Cable70" parent="." instance=ExtResource( 1 )]
position = Vector2( 288, 320 )
TYPE = 1

[node name="Cable72" parent="." instance=ExtResource( 1 )]
position = Vector2( 224, 320 )
TYPE = 1

[node name="Cable62" parent="." instance=ExtResource( 1 )]
position = Vector2( 384, 320 )
TYPE = 1

[node name="Cable63" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 320 )
TYPE = 1

[node name="Cable64" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 256 )
TYPE = 1

[node name="Cable65" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 224 )
TYPE = 1

[node name="Cable66" parent="." instance=ExtResource( 1 )]
position = Vector2( 416, 192 )
TYPE = 1

[node name="Cable7" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 192 )
TYPE = 3

[node name="Cable8" parent="." instance=ExtResource( 1 )]
position = Vector2( 320, 160 )
TYPE = 2

[node name="Bedroom" parent="." instance=ExtResource( 4 )]
position = Vector2( 352, 160 )
CONSUMPTION_RATE = 3

[node name="Bedroom2" parent="." instance=ExtResource( 4 )]
position = Vector2( 288, 288 )
CONSUMPTION_RATE = 5

[node name="Bedroom3" parent="." instance=ExtResource( 4 )]
position = Vector2( 480, 96 )
CONSUMPTION_RATE = 5

[node name="Bedroom4" parent="." instance=ExtResource( 4 )]
position = Vector2( 448, 192 )
CONSUMPTION_RATE = 5

[node name="BloodBank" parent="." instance=ExtResource( 5 )]
position = Vector2( 288, 32 )
CONSUMPTION_RATE = 10

[node name="Control" type="Control" parent="."]
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
margin_top = -232.0
mouse_filter = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="VBoxContainer" type="VBoxContainer" parent="Control"]
anchor_right = 0.992
anchor_bottom = 1.0
margin_left = 32.0
margin_top = 24.0
margin_right = -847.808
margin_bottom = -158.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="HBoxContainer" type="HBoxContainer" parent="Control/VBoxContainer"]
margin_right = 136.0
margin_bottom = 14.0

[node name="CurrentPower" type="Label" parent="Control/VBoxContainer/HBoxContainer"]
margin_right = 114.0
margin_bottom = 14.0
text = "Generated Power:"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="PowerValue" type="Label" parent="Control/VBoxContainer/HBoxContainer"]
margin_left = 118.0
margin_right = 118.0
margin_bottom = 14.0

[node name="HBoxContainer2" type="HBoxContainer" parent="Control/VBoxContainer"]
margin_top = 18.0
margin_right = 136.0
margin_bottom = 32.0

[node name="PowerConsumption" type="Label" parent="Control/VBoxContainer/HBoxContainer2"]
margin_right = 132.0
margin_bottom = 14.0
text = "Power Consumption:"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ConsumptionValue" type="Label" parent="Control/VBoxContainer/HBoxContainer2"]
margin_left = 136.0
margin_right = 136.0
margin_bottom = 14.0

[node name="HBoxContainer3" type="HBoxContainer" parent="Control/VBoxContainer"]
margin_top = 36.0
margin_right = 136.0
margin_bottom = 50.0

[node name="NetPower" type="Label" parent="Control/VBoxContainer/HBoxContainer3"]
margin_right = 70.0
margin_bottom = 14.0
text = "Net Power:"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="NetValue" type="Label" parent="Control/VBoxContainer/HBoxContainer3"]
margin_left = 74.0
margin_right = 74.0
margin_bottom = 14.0

[node name="XRay" parent="." instance=ExtResource( 3 )]
position = Vector2( 384, 288 )
CONSUMPTION_RATE = 20
